<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.qly.mapper.QuestMapper">

	<!-- <select id="getAllQuests" resultType="com.qly.dto.QuestDto"> SELECT 
		QUEST_ID, TITLE, CATEGORY, PHOTO_PATH, STATUS, REG_DATE, (SELECT COUNT(*) 
		FROM QUEST_APPLICATION qa WHERE qa.QUEST_ID = q.QUEST_ID) AS applicantCount 
		FROM QUESTS q ORDER BY CREATED_AT DESC </select> -->

	<select id="getAllQuests" resultType="com.qly.dto.QuestDto">
		SELECT
		QUEST_ID,
		USER_ID,
		TITLE,
		CATEGORY,
		CONTENT,
		PHOTO_PATH,
		STATUS,
		PROGRESS,
		LATITUDE,
		LONGITUDE,
		ADDRESS,
		LOCATION,
		START_DATE,
		END_DATE,
		CREATED_AT,
		VIEW_COUNT,
		REWARD_TOKENS,
		REG_DATE,
		(SELECT COUNT(*) FROM
		QUEST_APPLICATION qa WHERE
		qa.QUEST_ID = QUESTS.QUEST_ID) AS
		applicantCount
		FROM QUESTS
		ORDER BY
		CREATED_AT DESC
	</select>



	<!-- 2. 특정 QUEST_ID의 tasks 목록 조회 -->
	<!-- <select id="searchQuests" parameterType="int" resultType="com.qly.dto.QuestTaskDto"> 
		SELECT TASK_ID, QUEST_ID, DESCRIPTION, IS_CHECKED FROM QUEST_TASK WHERE QUEST_ID 
		= #{questId} </select> -->

	<!-- 퀘스트 저장 -->
	<insert id="insertQuest" parameterType="questdto"
		useGeneratedKeys="true" keyProperty="questId">
		INSERT INTO QUESTS (
		QUEST_ID, USER_ID, TITLE, CATEGORY, CONTENT, PHOTO_PATH, STATUS,
		PROGRESS, LATITUDE, LONGITUDE, ADDRESS, LOCATION, START_DATE,
		END_DATE, CREATED_AT, VIEW_COUNT, REWARD_TOKENS, REG_DATE
		) VALUES (
		SEQ_QUEST_ID.NEXTVAL, #{userId}, #{title}, #{category}, #{content}, #{photoPath},
		#{status},
		#{progress}, #{latitude}, #{longitude}, #{address}, #{location},
		#{startDate}, #{endDate}, SYSDATE, #{viewCount}, #{rewardTokens}, SYSDATE
		)
	</insert>

	<!-- 퀘스트 태스크 여러 건 저장 -->
	<insert id="insertQuestTasks" parameterType="list">
		INSERT INTO QUEST_TASK (TASK_ID, QUEST_ID, DESCRIPTION, IS_CHECKED)
		VALUES
		<foreach collection="list" item="task" separator=",">
			(SEQ_TASK_ID.NEXTVAL, #{task.questId}, #{task.description},
			#{task.isChecked})
		</foreach>
	</insert>

 <insert id="insertUser" parameterType="com.qly.dto.UserDto">
   INSERT INTO USERS (
      USER_ID, USERNAME, PASSWORD, PHONE, ADDRESS, EMAIL, USER_TYPE
  ) VALUES (
      #{userId},
      #{userName},
      #{password},
      #{phone},
      #{address},
      #{email},
      #{userType}
  )
  </insert>



</mapper>
